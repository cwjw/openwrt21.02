name: OpenWRT Cloud Build (21.02)

on:
  push:
    branches: [ main, master ]
    paths:
      - '.config'
      - '.github/workflows/openwrt-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: æ£€å‡ºå½“å‰ç¼–è¯‘ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # ä¼˜åŒ–ç½‘ç»œé…ç½®
    - name: ä¼˜åŒ–ç½‘ç»œé…ç½®
      run: |
        echo "max-time = 300" >> ~/.curlrc
        echo "retry = 2" >> ~/.curlrc
        echo "retry-delay = 10" >> ~/.curlrc
        git config --global http.timeout 300
        git config --global https.timeout 300
        git config --global http.retry 2

    # ç¼“å­˜aptåŒ…ï¼ˆåŠ é€Ÿä¾èµ–å®‰è£…ï¼‰
    - name: ç¼“å­˜aptåŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-apt
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-apt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-apt-

    # å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆç›´æ¥å…¨é‡å®‰è£…ï¼Œé¿å…æ£€æŸ¥ç¼ºå¤±ï¼‰
    - name: å®‰è£…OpenWRTç¼–è¯‘ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev ecj fastjar java-propose-classpath bc
        sudo apt-get clean -y

    # å…‹éš†OpenWRTæºç ï¼ˆå…¼å®¹ä»»æ„ä»“åº“ï¼Œä¼˜å…ˆå®˜æ–¹ï¼‰
    - name: å…‹éš†OpenWRTæºç 
      run: |
        rm -rf ./openwrt
        # å¯é€‰1ï¼šå…‹éš†å®˜æ–¹21.02.7ï¼ˆæ¨èï¼‰
        git clone --depth=1 https://github.com/openwrt/openwrt.git -b v21.02.7 openwrt || \
        # å¯é€‰2ï¼šå…‹éš†ä½ çš„ç¬¬ä¸‰æ–¹ä»“åº“ï¼ˆå¤‡ç”¨ï¼‰
        git clone --depth=1 https://github.com/cwjw/OpenWRT.git openwrt
        
        # å¼ºåˆ¶æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "./openwrt" ]; then
          echo "âŒ å…‹éš†ä»“åº“å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
          exit 1
        fi
        echo "âœ… æˆåŠŸå…‹éš†OpenWRTæºç "

    # å¤åˆ¶é…ç½®æ–‡ä»¶
    - name: å¤åˆ¶.configé…ç½®æ–‡ä»¶
      run: |
        cp -f ./.config ./openwrt/.config
        if [ ! -f "./openwrt/.config" ]; then
          echo "âŒ æœªæ‰¾åˆ°.configæ–‡ä»¶ï¼Œç»ˆæ­¢æµç¨‹"
          exit 1
        fi
        echo "âœ… .configæ–‡ä»¶å·²å¤åˆ¶"

    # æ›´æ–°feedsï¼ˆè·³è¿‡æºæ›¿æ¢ï¼‰
    - name: æ›´æ–°feeds
      run: |
        cd openwrt
        # é‡ç½®feedsé…ç½®ä¸ºå®˜æ–¹æº
        echo "src-git packages https://github.com/openwrt/packages.git;openwrt-21.02" > feeds.conf.default
        echo "src-git luci https://github.com/openwrt/luci.git;openwrt-21.02" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;openwrt-21.02" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-21.02" >> feeds.conf.default
        
        # æ‰§è¡Œfeedsæ›´æ–°ï¼ˆå¤±è´¥é‡è¯•ï¼‰
        ./scripts/feeds update -a || ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… feedsæ›´æ–°å®Œæˆ"

    # ç¼“å­˜ä¾èµ–åŒ…ç›®å½•
    - name: ç¼“å­˜ç¼–è¯‘ä¾èµ–åŒ…
      uses: actions/cache@v3
      id: cache-dl
      with:
        path: ./openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('./openwrt/.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    # ä¸‹è½½ä¾èµ–åŒ…ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šè·³è¿‡sedï¼Œç›´æ¥ä¸‹è½½ï¼‰
    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
      if: steps.cache-dl.outputs.cache-hit != 'true'
      run: |
        cd openwrt
        # ç”Ÿæˆé…ç½®ï¼ˆå¿…é€‰æ­¥éª¤ï¼‰
        make defconfig
        # è®¾ç½®è¶…æ—¶æ—¶é—´
        export DOWNLOAD_TIMEOUT=300
        
        echo "ğŸ“œ å¼€å§‹ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆä½¿ç”¨é»˜è®¤æºï¼‰"
        # å¤šçº¿ç¨‹ä¸‹è½½ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
        make download -j$(nproc) V=s || make download -j1 V=s
        
        # æ¸…ç†æ®‹ç¼ºåŒ…
        find dl -size -1024c -exec rm -f {} \;
        # éªŒè¯ä¸‹è½½ç»“æœ
        echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆï¼Œç»Ÿè®¡ä¿¡æ¯ï¼š"
        ls -lh dl | wc -l
        du -sh dl
        echo "ğŸ” æ®‹ç¼ºåŒ…æ£€æŸ¥ï¼š$(find dl -size 0 | wc -l) ä¸ª"

    # å¼€å§‹ç¼–è¯‘ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
    - name: ç¼–è¯‘OpenWRTå›ºä»¶
      run: |
        cd openwrt
        # ç¼–è¯‘ï¼ˆå¤šçº¿ç¨‹å¤±è´¥åˆ™å•çº¿ç¨‹ï¼‰
        make -j$(nproc) V=s || make -j1 V=s
        echo "âœ… ç¼–è¯‘å®Œæˆ"

    # å¤åˆ¶äº§ç‰©
    - name: å¤åˆ¶ç¼–è¯‘äº§ç‰©
      run: |
        mkdir -p ./openwrt-firmware
        cp -rf ./openwrt/bin/targets/* ./openwrt-firmware/
        echo "ğŸ“ ç¼–è¯‘äº§ç‰©å·²å¤åˆ¶åˆ° openwrt-firmware ç›®å½•"

    # ä¸Šä¼ äº§ç‰©åˆ°Artifact
    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-21.02-firmware
        path: ./openwrt-firmware/
        retention-days: 7
