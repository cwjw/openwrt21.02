name: OpenWRT Cloud Build (21.02)
on:
  push:
    branches: [ main, master ]
    paths:
      - '.config'
      - '.github/workflows/openwrt-build.yml'
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
        libelf-dev ecj fastjar java-propose-classpath
        # å®‰è£…è¿›åº¦ç›‘æ§ä¾èµ–
        sudo apt install -y bc
        sudo apt autoremove -y
        sudo apt clean -y
    - name: å…‹éš†OpenWRT 21.02æºç 
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        git checkout v21.02.7
        git pull
    - name: å¤åˆ¶ä»“åº“æ ¹ç›®å½•çš„.configåˆ°OpenWRTæºç ç›®å½•
      run: |
        cp -f ./.config ./openwrt/.config
        if [ -f ./openwrt/.config ]; then
          echo "âœ… .config æ–‡ä»¶å·²æˆåŠŸå¤åˆ¶"
          cat ./openwrt/.config | head -10
        else
          echo "âŒ æœªæ‰¾åˆ°.configæ–‡ä»¶ï¼Œç¼–è¯‘ç»ˆæ­¢"
          exit 1
        fi
    - name: æ›´æ–°feedså¹¶å®‰è£…
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    - name: ç”Ÿæˆç¼–è¯‘ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºè¿›åº¦è®¡ç®—ï¼‰
      run: |
        cd openwrt
        # é¢„ç¼–è¯‘ç”Ÿæˆä»»åŠ¡åˆ—è¡¨ï¼Œç»Ÿè®¡æ€»ä»»åŠ¡æ•°
        make -j1 -n > build_tasks.log 2>&1
        # ç»Ÿè®¡å®é™…ç¼–è¯‘ä»»åŠ¡æ•°ï¼ˆè¿‡æ»¤æ‰æ— å…³æ—¥å¿—ï¼‰
        TOTAL_TASKS=$(grep -E '^make\[.*\]: Entering directory|^cc |^gcc |^g\+\+ ' build_tasks.log | wc -l)
        echo "æ€»ç¼–è¯‘ä»»åŠ¡æ•°: $TOTAL_TASKS"
        echo "TOTAL_TASKS=$TOTAL_TASKS" >> $GITHUB_ENV
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f build_tasks.log
    - name: å¼€å§‹ç¼–è¯‘ï¼ˆå¸¦å®æ—¶è¿›åº¦æ˜¾ç¤ºï¼‰
      run: |
        cd openwrt
        # åˆ›å»ºè¿›åº¦ç›‘æ§è„šæœ¬
        cat > progress_monitor.sh << 'EOF'
        #!/bin/bash
        # å®æ—¶ç›‘æ§ç¼–è¯‘æ—¥å¿—ï¼Œè®¡ç®—è¿›åº¦
        LOG_FILE="build.log"
        TOTAL_TASKS=$1
        CURRENT_TASK=0
        # å¾ªç¯ç›‘æ§æ—¥å¿—æ–‡ä»¶
        while [ -f "$LOG_FILE" ]; do
            # ç»Ÿè®¡å·²å®Œæˆçš„ä»»åŠ¡æ•°
            CURRENT_TASK=$(grep -E '^cc |^gcc |^g\+\+ ' "$LOG_FILE" | wc -l)
            # è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
            if [ $TOTAL_TASKS -gt 0 ]; then
                PROGRESS=$(echo "scale=2; $CURRENT_TASK / $TOTAL_TASKS * 100" | bc)
                echo -e "\033[32mğŸ“Š ç¼–è¯‘è¿›åº¦: $CURRENT_TASK/$TOTAL_TASKS ($PROGRESS%)\033[0m"
            fi
            # æ¯10ç§’æ›´æ–°ä¸€æ¬¡è¿›åº¦
            sleep 10
        done
        EOF
        chmod +x progress_monitor.sh
        # åå°è¿è¡Œè¿›åº¦ç›‘æ§è„šæœ¬
        ./progress_monitor.sh $TOTAL_TASKS &
        MONITOR_PID=$!
        # å¼€å§‹ç¼–è¯‘ï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ï¼ˆåŒæ—¶ç»ˆç«¯ä¹Ÿè¾“å‡ºï¼‰
        echo -e "\033[34mğŸš€ å¼€å§‹ç¼–è¯‘OpenWRT 21.02ï¼Œæ€»ä»»åŠ¡æ•°: $TOTAL_TASKS\033[0m"
        make -j$(nproc) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee -a build.log
        # ç¼–è¯‘å®Œæˆååœæ­¢ç›‘æ§è„šæœ¬
        kill $MONITOR_PID
        rm -f progress_monitor.sh
        # è¾“å‡ºæœ€ç»ˆè¿›åº¦
        echo -e "\033[32mâœ… ç¼–è¯‘å®Œæˆï¼æœ€ç»ˆè¿›åº¦: 100%\033[0m"
        ls -lh ./bin/targets/
    - name: å¤åˆ¶ç¼–è¯‘äº§ç‰©åˆ°ä»“åº“æ ¹ç›®å½•
      run: |
        mkdir -p ./openwrt-firmware
        cp -rf ./openwrt/bin/targets/* ./openwrt-firmware/
        echo "ğŸ“ æ ¹ç›®å½•å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh ./openwrt-firmware/
        du -sh ./openwrt-firmware/
    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆå¤‡ä»½ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-21.02
        path: ./openwrt-firmware/
        retention-days: 7
    - name: æ¨é€å›ºä»¶åˆ°ä»“åº“æ ¹ç›®å½•
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git pull
        git add ./openwrt-firmware/
        git commit -m "Add OpenWRT 21.02 firmware build at $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— æ–°å›ºä»¶éœ€è¦æäº¤"
        git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
