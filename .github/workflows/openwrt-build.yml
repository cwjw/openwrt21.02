name: OpenWRT 21.02 云编译（MT7620A+4G+WireGuard+中文）
on:
  workflow_dispatch:  # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-20.04  # 兼容OpenWRT 21.02编译环境
    steps:
      - name: 检查代码
        uses: actions/checkout@v3

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      - name: 克隆OpenWRT 21.02官方源码
        run: |
          git clone -b openwrt-21.02 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          # 更新feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 集成lean插件（兼容21.02版本）
        run: |
          cd openwrt
          mkdir -p package/lean
          # 下载lean插件并清理不兼容文件
          wget https://codeload.github.com/coolsnowwolf/lede/zip/refs/heads/master -O lede-master.zip
          unzip -q lede-master.zip "lede-master/package/lean/*" -d tmp
          mv tmp/lede-master/package/lean/* package/lean/
          rm -rf tmp lede-master.zip
          # 删除不兼容插件，避免编译报错
          rm -rf package/lean/{optee-os-stm32,bpf-headers,pcat-manager,openssl,qosify,bridger,unetd,dpdk,apk,dtc}
          rm -rf package/lean/target/linux/

      - name: 上传自定义.config配置文件
        run: |
          # 将本地的.config（提前配置好的）复制到openwrt目录
          cp .config openwrt/.config
        # 注意：如果.config在仓库根目录，需先上传到GitHub仓库

      - name: 下载编译依赖包
        run: |
          cd openwrt
          make download -j8

      - name: 开始编译固件
        run: |
          cd openwrt
          make -j$(nproc) V=s

      - name: 上传编译产物
        uses: actions/upload-artifact@v3
        with:
          name: openwrt-21.02-mt7620a-firmware
          path: openwrt/bin/targets/ramips/mt7620/*.bin
