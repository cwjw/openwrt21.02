name: OpenWRT Cloud Build (21.02)

# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»£ç ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main, master ]
    paths:
      - '.config'
      - '.github/workflows/openwrt-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt update -y
        sudo apt full-upgrade -y
        # 21.02ç‰ˆæœ¬ç¼–è¯‘ä¾èµ–è¡¥å……
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
        gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
        libelf-dev ecj fastjar java-propose-classpath
        sudo apt autoremove -y
        sudo apt clean -y

    - name: å…‹éš†OpenWRT 21.02æºç 
      run: |
        git clone https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        # åˆ‡æ¢åˆ°21.02ç¨³å®šç‰ˆæœ¬ï¼ˆæœ€æ–°21.02.7ï¼‰
        git checkout v21.02.7
        # æ›´æ–°æºç åˆ°æœ€æ–°
        git pull

    - name: å¤åˆ¶ä»“åº“æ ¹ç›®å½•çš„.configåˆ°OpenWRTæºç ç›®å½•
      run: |
        cp -f ./.config ./openwrt/.config
        if [ -f ./openwrt/.config ]; then
          echo "âœ… .config æ–‡ä»¶å·²æˆåŠŸå¤åˆ¶"
          cat ./openwrt/.config | head -10
        else
          echo "âŒ æœªæ‰¾åˆ°.configæ–‡ä»¶ï¼Œç¼–è¯‘ç»ˆæ­¢"
          exit 1
        fi

    - name: æ›´æ–°feedså¹¶å®‰è£…
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: å¼€å§‹ç¼–è¯‘
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        ls -lh ./bin/targets/

    - name: å¤åˆ¶ç¼–è¯‘äº§ç‰©åˆ°ä»“åº“æ ¹ç›®å½•
      run: |
        # åˆ›å»ºæ ¹ç›®å½•å›ºä»¶å­˜æ”¾æ–‡ä»¶å¤¹
        mkdir -p ./openwrt-firmware
        # å¤åˆ¶æ‰€æœ‰ç¼–è¯‘äº§ç‰©åˆ°æ ¹ç›®å½•çš„openwrt-firmwareæ–‡ä»¶å¤¹
        cp -rf ./openwrt/bin/targets/* ./openwrt-firmware/
        # éªŒè¯å¤åˆ¶ç»“æœ
        echo "ğŸ“ æ ¹ç›®å½•å›ºä»¶æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh ./openwrt-firmware/
        # è¾“å‡ºå›ºä»¶å¤§å°ä¿¡æ¯
        du -sh ./openwrt-firmware/

    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆå¤‡ä»½ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-21.02
        path: ./openwrt-firmware/
        retention-days: 7

    - name: æ¨é€å›ºä»¶åˆ°ä»“åº“æ ¹ç›®å½•ï¼ˆå¯é€‰ï¼šéœ€è¦å¼€å¯å†™å…¥æƒé™ï¼‰
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½®gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé¿å…å†²çªï¼‰
        git pull
        # æ·»åŠ å›ºä»¶æ–‡ä»¶åˆ°ä»“åº“
        git add ./openwrt-firmware/
        # æäº¤æ›´æ”¹
        git commit -m "Add OpenWRT 21.02 firmware build at $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— æ–°å›ºä»¶éœ€è¦æäº¤"
        # æ¨é€åˆ°ä»“åº“
        git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
