- name: æ™ºèƒ½ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆGitHubä¼˜å…ˆï¼Œå®˜æ–¹å¤‡ç”¨ï¼‰
  if: steps.cache-dl.outputs.cache-hit != 'true'
  run: |
    cd openwrt
    make defconfig
    export DOWNLOAD_TIMEOUT=300

    # 1. åˆå§‹é…ç½®ï¼šOpenWRT GitHubä¸‹è½½é•œåƒæºï¼ˆä¼˜å…ˆï¼‰
    # é€‚é…21.02ç‰ˆæœ¬ï¼šå®½æ¾åŒ¹é…downloads.openwrt.orgåŸŸå
    sed -i 's@downloads.openwrt.org@github.com/openwrt/releases-mirror/raw/master@g' ./include/download.mk
    echo "ğŸ“œ åˆå§‹ä¾èµ–é…ç½®ï¼ˆGitHubä¼˜å…ˆæºï¼‰ï¼š"
    grep -n "github.com/openwrt/releases-mirror" ./include/download.mk

    # 2. GitHubæºå°è¯•2æ¬¡ï¼ˆå¤šçº¿ç¨‹ï¼‰
    echo -e "\033[34mğŸ”¹ ç¬¬1æ¬¡å°è¯•ï¼šGitHubé•œåƒæºä¸‹è½½ä¾èµ–ï¼ˆå¤šçº¿ç¨‹ï¼‰\033[0m"
    make download -j4 V=s > download.log 2>&1
    if [ $? -ne 0 ]; then
      echo -e "\033[33mâš ï¸  GitHubæºç¬¬1æ¬¡å¤±è´¥ï¼Œé‡è¯•ç¬¬2æ¬¡\033[0m"
      make download -j4 V=s > download_2.log 2>&1
      if [ $? -ne 0 ]; then
        echo -e "\033[31mâŒ GitHubæºè¿ç»­2æ¬¡å¤±è´¥ï¼Œåˆ‡æ¢å®˜æ–¹å¤‡ç”¨æº\033[0m"
        # 3. åˆ‡æ¢åˆ°å®˜æ–¹å¤‡ç”¨æºï¼ˆè¿˜åŸdownloads.openwrt.orgï¼‰
        sed -i 's@github.com/openwrt/releases-mirror/raw/master@downloads.openwrt.org@g' ./include/download.mk
        echo "ğŸ“œ ä¸´æ—¶ä¾èµ–é…ç½®ï¼ˆå®˜æ–¹å¤‡ç”¨æºï¼‰ï¼š"
        grep -n "downloads.openwrt.org" ./include/download.mk
        # 4. å®˜æ–¹å¤‡ç”¨æºå•çº¿ç¨‹ä¸‹è½½
        echo -e "\033[34mğŸ”¹ å°è¯•ï¼šå®˜æ–¹å¤‡ç”¨æºä¸‹è½½ä¾èµ–ï¼ˆå•çº¿ç¨‹ï¼‰\033[0m"
        make download -j1 V=s
        if [ $? -ne 0 ]; then
          echo -e "\033[31mâŒ å®˜æ–¹å¤‡ç”¨æºä¹Ÿå¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹\033[0m"
          exit 1
        fi
        echo -e "\033[32mâœ… å®˜æ–¹å¤‡ç”¨æºæˆåŠŸï¼Œåˆ‡å›GitHubä¼˜å…ˆæº\033[0m"
        # 5. åˆ‡å›GitHubæºï¼ˆæ¢å¤ä¼˜å…ˆé…ç½®ï¼‰
        sed -i 's@downloads.openwrt.org@github.com/openwrt/releases-mirror/raw/master@g' ./include/download.mk
      fi
    fi

    # 6. æ¸…ç†æ— æ•ˆä¾èµ–åŒ…
    find dl -size -1024c -exec ls -l {} \;
    find dl -size -1024c -exec rm -f {} \;
    echo -e "\033[32mâœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ\033[0m"
