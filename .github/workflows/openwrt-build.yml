name: OpenWRT Cloud Build (21.02)

on:
  push:
    branches: [ main, master ]
    paths:
      - '.config'
      - '.github/workflows/openwrt-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç¼–è¯‘ä¸­æ–­

    steps:
    - name: æ£€å‡ºå½“å‰ç¼–è¯‘ä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # ä¼˜åŒ–ç³»ç»Ÿç½‘ç»œé…ç½®
    - name: ä¼˜åŒ–ç½‘ç»œé…ç½®
      run: |
        # é…ç½®curlè¶…æ—¶å’Œé‡è¯•
        echo "max-time = 300" >> ~/.curlrc
        echo "retry = 2" >> ~/.curlrc
        echo "retry-delay = 10" >> ~/.curlrc
        # é…ç½®gitè¶…æ—¶
        git config --global http.timeout 300
        git config --global https.timeout 300
        git config --global http.retry 2

    # ç¼“å­˜aptåŒ…ç¼“å­˜ï¼ˆé¿å…é‡å¤ä¸‹è½½ï¼‰
    - name: ç¼“å­˜aptåŒ…ç¼“å­˜
      uses: actions/cache@v3
      id: cache-apt
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/openwrt-build.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    # ç¼“å­˜ç¼–è¯‘ç¯å¢ƒï¼ˆå…¨é‡å·¥å…·ï¼‰
    - name: ç¼“å­˜ç¼–è¯‘ç¯å¢ƒ
      uses: actions/cache@v3
      id: cache-env
      with:
        path: |
          /usr/local
          /usr/lib
          /usr/bin
          /usr/include
          /bin
          /sbin
        key: ${{ runner.os }}-openwrt-21.02-env-full-${{ hashFiles('.github/workflows/openwrt-build.yml') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-21.02-env-full-

    # å¢é‡é…ç½®ç¼–è¯‘ç¯å¢ƒï¼ˆä»…å®‰è£…ç¼ºå¤±ä¾èµ–ï¼‰
    - name: éªŒè¯å¹¶é…ç½®ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
        APT_LISTCHANGES_FRONTEND: none
        APT_OPTIONS: '-o Dpkg::Use-Pty=0 -o APT::Color=0 -q'
      run: |
        # å®šä¹‰å¿…é¡»çš„ç¼–è¯‘ä¾èµ–åˆ—è¡¨
        REQUIRED_PACKAGES=(
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          libelf-dev ecj fastjar java-propose-classpath bc
        )

        # æ£€æŸ¥ç¼ºå¤±çš„ä¾èµ–åŒ…
        MISSING_PACKAGES=()
        for pkg in "${REQUIRED_PACKAGES[@]}"; do
          if ! dpkg -s "$pkg" >/dev/null 2>&1; then
            MISSING_PACKAGES+=("$pkg")
            echo "âš ï¸ ç¼ºå¤±ä¾èµ–ï¼š$pkg"
          fi
        done

        # ä»…å®‰è£…ç¼ºå¤±çš„ä¾èµ–
        if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
          echo "ğŸ“¦ å®‰è£…ç¼ºå¤±çš„ç¼–è¯‘ä¾èµ–ï¼ˆå…±${#MISSING_PACKAGES[@]}ä¸ªï¼‰"
          sudo apt-get update -y $APT_OPTIONS
          sudo apt-get install -y $APT_OPTIONS "${MISSING_PACKAGES[@]}"
          sudo apt-get autoremove -y $APT_OPTIONS
          sudo apt-get clean -y $APT_OPTIONS
        else
          echo -e "\033[32mâœ… æ‰€æœ‰ç¼–è¯‘ä¾èµ–å·²å­˜åœ¨ï¼Œè·³è¿‡ç¯å¢ƒé…ç½®\033[0m"
          # éªŒè¯æ ¸å¿ƒå·¥å…·
          gcc --version | head -1
          make --version | head -1
          git --version | head -1
        fi

    # å…‹éš†OpenWRTæºç å¹¶åˆ‡æ¢ç‰ˆæœ¬
    - name: å…‹éš†OpenWRTæºç å¹¶åˆ‡æ¢ç‰ˆæœ¬
      run: |
        rm -rf ./openwrt
        git clone -v https://github.com/openwrt/openwrt.git -b v21.02.7 openwrt
        if [ ! -d "./openwrt" ]; then
          echo "âŒ å…‹éš†ä»“åº“å¤±è´¥"
          ls -lh ./
          exit 1
        fi
        cd openwrt
        echo "âœ… æˆåŠŸåˆ‡æ¢åˆ°ç‰ˆæœ¬ï¼šv21.02.7"

    # å¤åˆ¶é…ç½®æ–‡ä»¶
    - name: å¤åˆ¶.configåˆ°OpenWRTç›®å½•
      run: |
        cp -f ./.config ./openwrt/.config
        if [ -f ./openwrt/.config ]; then
          echo "âœ… .config æ–‡ä»¶å·²å¤åˆ¶"
          head -10 ./openwrt/.config
        else
          echo "âŒ æœªæ‰¾åˆ°.configæ–‡ä»¶ï¼Œç»ˆæ­¢ç¼–è¯‘"
          exit 1
        fi

    # ç¼“å­˜feedså†…å®¹
    - name: ç¼“å­˜feedså†…å®¹
      id: cache-feeds
      uses: actions/cache@v3
      with:
        path: |
          ./openwrt/feeds
          ./openwrt/staging_dir/feeds
          ./openwrt/package/feeds
        key: ${{ runner.os }}-openwrt-21.02-feeds-${{ hashFiles('./openwrt/.config', './openwrt/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-21.02-feeds-

    # æ™ºèƒ½æ›´æ–°feedsï¼ˆGitHubä¼˜å…ˆï¼Œå®˜æ–¹å¤‡ç”¨ï¼‰
    - name: æ™ºèƒ½æ›´æ–°feeds
      if: steps.cache-feeds.outputs.cache-hit != 'true'
      run: |
        cd openwrt
        # é…ç½®GitHubæºä¼˜å…ˆ
        > feeds.conf.default
        echo "src-git packages https://github.com/openwrt/packages.git;openwrt-21.02" >> feeds.conf.default
        echo "src-git luci https://github.com/openwrt/luci.git;openwrt-21.02" >> feeds.conf.default
        echo "src-git routing https://github.com/openwrt/routing.git;openwrt-21.02" >> feeds.conf.default
        echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-21.02" >> feeds.conf.default
        echo "ğŸ“œ åˆå§‹feedsé…ç½®ï¼š"
        cat feeds.conf.default

        # å°è¯•GitHubæºæ›´æ–°
        echo -e "\033[34mğŸ”¹ ç¬¬1æ¬¡å°è¯•ï¼šGitHubæºæ›´æ–°feeds\033[0m"
        ./scripts/feeds update -a > feeds_update.log 2>&1
        if [ $? -ne 0 ]; then
          echo -e "\033[33mâš ï¸ GitHubæºå¤±è´¥ï¼Œé‡è¯•ç¬¬2æ¬¡\033[0m"
          ./scripts/feeds update -a > feeds_update_2.log 2>&1
          if [ $? -ne 0 ]; then
            echo -e "\033[31mâŒ GitHubæºå¤±è´¥ï¼Œåˆ‡æ¢å®˜æ–¹æº\033[0m"
            # åˆ‡æ¢å®˜æ–¹æº
            > feeds.conf.default
            echo "src-git packages https://git.openwrt.org/feed/packages.git^48242ee7a190db7740f7b9b3ef1debfa4d5857f6" >> feeds.conf.default
            echo "src-git luci https://git.openwrt.org/project/luci.git^e98243ef9eb838cca80cdd6d1bd0cf69a509d103" >> feeds.conf.default
            echo "src-git routing https://git.openwrt.org/feed/routing.git^8071852b4556a02533cacb7a0f6a432df3507302" >> feeds.conf.default
            echo "src-git telephony https://git.openwrt.org/feed/telephony.git^920fbc5c0a2e4badf51bceff42e9a1e3eb693462" >> feeds.conf.default
            ./scripts/feeds update -a
            if [ $? -ne 0 ]; then
              echo -e "\033[31mâŒ å®˜æ–¹æºä¹Ÿå¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹\033[0m"
              exit 1
            fi
            # åˆ‡å›GitHubæº
            > feeds.conf.default
            echo "src-git packages https://github.com/openwrt/packages.git;openwrt-21.02" >> feeds.conf.default
            echo "src-git luci https://github.com/openwrt/luci.git;openwrt-21.02" >> feeds.conf.default
            echo "src-git routing https://github.com/openwrt/routing.git;openwrt-21.02" >> feeds.conf.default
            echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-21.02" >> feeds.conf.default
          fi
        fi

        # å®‰è£…feeds
        ./scripts/feeds install -a
        echo -e "\033[32mâœ… feedsæ›´æ–°å®Œæˆ\033[0m"

    # feedsç¼“å­˜å‘½ä¸­æç¤º
    - name: feedsç¼“å­˜å‘½ä¸­æç¤º
      if: steps.cache-feeds.outputs.cache-hit == 'true'
      run: |
        echo -e "\033[32mâœ… feedsç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡æ›´æ–°\033[0m"
        ls -lh ./openwrt/feeds | head -10

    # ç¼“å­˜ç¼–è¯‘ä¾èµ–åŒ…
    - name: ç¼“å­˜ç¼–è¯‘ä¾èµ–åŒ…
      id: cache-dl
      uses: actions/cache@v3
      with:
        path: ./openwrt/dl
        key: ${{ runner.os }}-openwrt-21.02-dl-${{ hashFiles('./openwrt/.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-21.02-dl-

    # æ™ºèƒ½ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆé€‚é…21.02æºé…ç½®ï¼‰
    - name: æ™ºèƒ½ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…
      if: steps.cache-dl.outputs.cache-hit != 'true'
      run: |
        cd openwrt
        make defconfig
        export DOWNLOAD_TIMEOUT=300

        # é€‚é…21.02ï¼šä¿®æ”¹site.mkå’Œdownload.plçš„ä¸‹è½½æº
        echo "ğŸ“œ åˆ‡æ¢åˆ°GitHubé•œåƒæº"
        sed -i 's@OPENWRT_MIRROR:=.*@OPENWRT_MIRROR:=https://github.com/openwrt/releases-mirror/raw/master/@g' ./include/site.mk
        sed -i 's@https\?://downloads.openwrt.org/@https://github.com/openwrt/releases-mirror/raw/master/@g' ./scripts/download.pl
        
        # éªŒè¯æºæ›¿æ¢ç»“æœ
        echo "ğŸ” éªŒè¯ä¸‹è½½æºé…ç½®ï¼š"
        grep -n "OPENWRT_MIRROR" ./include/site.mk || echo "âš ï¸ site.mkæ— OPENWRT_MIRROR"

        # ç¬¬ä¸€æ¬¡å°è¯•ä¸‹è½½ï¼ˆå¤šçº¿ç¨‹ï¼‰
        echo -e "\033[34mğŸ”¹ ç¬¬1æ¬¡å°è¯•ï¼šGitHubæºä¸‹è½½ä¾èµ–\033[0m"
        make download -j4 V=s > download.log 2>&1
        if [ $? -ne 0 ]; then
          echo -e "\033[33mâš ï¸ GitHubæºå¤±è´¥ï¼Œé‡è¯•ç¬¬2æ¬¡\033[0m"
          make download -j4 V=s > download_2.log 2>&1
          if [ $? -ne 0 ]; then
            echo -e "\033[31mâŒ GitHubæºå¤±è´¥ï¼Œåˆ‡æ¢å®˜æ–¹æº\033[0m"
            # è¿˜åŸå®˜æ–¹æº
            sed -i 's@OPENWRT_MIRROR:=https://github.com/openwrt/releases-mirror/raw/master/@OPENWRT_MIRROR:=https://downloads.openwrt.org/@g' ./include/site.mk
            sed -i 's@https://github.com/openwrt/releases-mirror/raw/master/@https://downloads.openwrt.org/@g' ./scripts/download.pl
            # å®˜æ–¹æºå•çº¿ç¨‹ä¸‹è½½
            make download -j1 V=s
            if [ $? -ne 0 ]; then
              echo -e "\033[31mâŒ å®˜æ–¹æºä¹Ÿå¤±è´¥ï¼Œç»ˆæ­¢\033[0m"
              exit 1
            fi
            # åˆ‡å›GitHubæº
            sed -i 's@OPENWRT_MIRROR:=https://downloads.openwrt.org/@OPENWRT_MIRROR:=https://github.com/openwrt/releases-mirror/raw/master/@g' ./include/site.mk
          fi
        fi

        # æ¸…ç†æ®‹ç¼ºåŒ…+éªŒè¯ä¸‹è½½ç»“æœ
        find dl -size -1024c -exec rm -f {} \;
        echo -e "\033[32mâœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ\033[0m"
        echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡ï¼š"
        ls -lh ./dl | wc -l
        du -sh ./dl
        find ./dl -size 0 -exec echo "âŒ æ®‹ç¼ºåŒ…ï¼š{}" \;

    # ä¾èµ–ç¼“å­˜å‘½ä¸­æç¤º
    - name: ä¾èµ–ç¼“å­˜å‘½ä¸­æç¤º
      if: steps.cache-dl.outputs.cache-hit == 'true'
      run: |
        echo -e "\033[32mâœ… ä¾èµ–åŒ…ç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡ä¸‹è½½\033[0m"
        ls -lh ./openwrt/dl | head -10

    # ç”Ÿæˆç¼–è¯‘ä»»åŠ¡åˆ—è¡¨
    - name: ç”Ÿæˆç¼–è¯‘ä»»åŠ¡åˆ—è¡¨
      run: |
        cd openwrt
        make -j1 -n > build_tasks.log 2>&1
        TOTAL_TASKS=$(grep -E '^make\[.*\]: Entering directory|^cc |^gcc |^g\+\+ ' build_tasks.log | wc -l)
        echo "æ€»ç¼–è¯‘ä»»åŠ¡æ•°ï¼š$TOTAL_TASKS"
        echo "TOTAL_TASKS=$TOTAL_TASKS" >> $GITHUB_ENV
        rm -f build_tasks.log

    # å¼€å§‹ç¼–è¯‘ï¼ˆå¸¦è¿›åº¦ç›‘æ§ï¼‰
    - name: å¼€å§‹ç¼–è¯‘OpenWRT
      run: |
        cd openwrt
        # è¿›åº¦ç›‘æ§è„šæœ¬
        cat > progress_monitor.sh << 'EOF'
        #!/bin/bash
        LOG_FILE="build.log"
        TOTAL_TASKS=$1
        CURRENT_TASK=0
        while [ -f "$LOG_FILE" ]; do
            CURRENT_TASK=$(grep -E '^cc |^gcc |^g\+\+ ' "$LOG_FILE" | wc -l)
            if [ $TOTAL_TASKS -gt 0 ]; then
                PROGRESS=$(echo "scale=2; $CURRENT_TASK / $TOTAL_TASKS * 100" | bc)
                echo -e "\033[32mğŸ“Š ç¼–è¯‘è¿›åº¦: $CURRENT_TASK/$TOTAL_TASKS ($PROGRESS%)\033[0m"
            fi
            sleep 10
        done
        EOF
        chmod +x progress_monitor.sh
        ./progress_monitor.sh ${{ env.TOTAL_TASKS }} &
        MONITOR_PID=$!

        # æ‰§è¡Œç¼–è¯‘ï¼ˆå¤±è´¥æ—¶é™çº§å•çº¿ç¨‹ï¼‰
        echo -e "\033[34mğŸš€ å¼€å§‹ç¼–è¯‘OpenWRT 21.02\033[0m"
        make -j$(nproc) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee -a build.log

        # åœæ­¢ç›‘æ§
        kill $MONITOR_PID
        rm -f progress_monitor.sh
        echo -e "\033[32mâœ… ç¼–è¯‘å®Œæˆ\033[0m"
        ls -lh ./bin/targets/

    # å¤åˆ¶ç¼–è¯‘äº§ç‰©
    - name: å¤åˆ¶ç¼–è¯‘äº§ç‰©åˆ°ä»“åº“ç›®å½•
      run: |
        mkdir -p ./openwrt-firmware
        cp -rf ./openwrt/bin/targets/* ./openwrt-firmware/
        echo "ğŸ“ ç¼–è¯‘äº§ç‰©åˆ—è¡¨ï¼š"
        ls -lh ./openwrt-firmware/
        du -sh ./openwrt-firmware/

    # ä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆå¤‡ä»½ï¼‰
    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©åˆ°Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-21.02-firmware
        path: ./openwrt-firmware/
        retention-days: 7

    # æ¨é€äº§ç‰©åˆ°ä»“åº“
    - name: æ¨é€ç¼–è¯‘äº§ç‰©åˆ°ä»£ç ä»“åº“
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        # å¤„ç†æ‹‰å–å†²çª
        git pull origin ${{ github.ref_name }} --rebase || git pull origin ${{ github.ref_name }} --rebase --autostash
        # æ·»åŠ äº§ç‰©
        git add ./openwrt-firmware/
        # æäº¤ï¼ˆå®¹é”™ï¼‰
        git commit -m "Build OpenWRT 21.02 firmware at $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— æ–°äº§ç‰©ï¼Œè·³è¿‡æäº¤"
        # æ¨é€ï¼ˆå®¹é”™ï¼‰
        git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }} || echo "æ¨é€å¤±è´¥ï¼ˆæ— æ–°å†…å®¹ï¼‰"
